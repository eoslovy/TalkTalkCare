image: docker:latest

stages:
  - build
  - deploy

# 모든 Job에 공통 설정을 적용
default:
  # 도커를 서비스로 사용 (docker:dind)
  services:
    - name: docker:dind
      alias: docker
  
  variables:
    # Docker in Docker(dind) 관련 변수
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2

    FF_NETWORK_PER_BUILD: "true"
    CI_DEBUG_TRACE: "true"

  before_script:
    - apk add --no-cache docker-compose
    - |
      until docker info; do
        echo "Waiting for docker to start..."
        sleep 1
      done
    - docker network create cicd_network || true
  privileged: true

build-backend:
  stage: build
  script:
    - docker-compose -f docker-compose.yml build backend
  rules:
    - changes:
        - backend/**
      when: always

build-frontend:
  stage: build
  script:
    - docker-compose -f docker-compose.yml build frontend
  rules:
    - changes:
        - frontend/**
      when: always

deploy-backend:
  stage: deploy
  script:
    - docker-compose -f docker-compose.yml up -d backend
  rules:
    - changes:
        - backend/**
      when: always

deploy-frontend:
  stage: deploy
  script:
    - docker-compose -f docker-compose.yml up -d frontend
  rules:
    - changes:
        - frontend/**
      when: always
